# Memory layout

```
------------ 0 byte
Magic 
------------ 8 byte
Params  
------------ 16 byte
Header
------------ 32 byte
Message 0
------------ 40+ byte
Message 1
------------ 48+ byte
...
------------
```

### Magic
```
576f726b20697320    Uint64
```

### Params
```
QUEUE_MAX_LEN   Uint32
MSG_SIZE        Uint32
```

### Header
```
HEADER_LOCK Uint64
START_IDX   Uint32
QUEUE_LEN   Uint32
```

### Message
```
MSG_LOCK    Uint64
MSG_DATA    [MSG_SIZE]Uint64
```

### Algorithm
Let `QUEUE_LEN=5`, `MSG_SIZE=3`.

Enqueue to empty:
```
HEADER   MSG_0    MSG_1    MSG_2    MSG_3    MSG_4
----------------------------------------------------
[. 0 0]  {. ...}  {. ...}  {. ...}  {. ...}  {. ...}    # Queue is empty
----------------------------------------------------
[X 0 0]  {. ...}  {. ...}  {. ...}  {. ...}  {. ...}    # Lock header
----------------------------------------------------
[X 0 1]  {X ...}  {. ...}  {. ...}  {. ...}  {. ...}    # Increment QUEUE_LEN, lock MSG_0
----------------------------------------------------
[. 0 1]  {X ...}  {. ...}  {. ...}  {. ...}  {. ...}    # Unlock header
----------------------------------------------------
[. 0 1]  {X aaa}  {. ...}  {. ...}  {. ...}  {. ...}    # Write MSG_0 data
----------------------------------------------------
[. 0 1]  {. aaa}  {. ...}  {. ...}  {. ...}  {. ...}    # Unlock MSG_0
 ^ ^ ^    ^ ^^^
LK | |   LK |||
STRT |     DATA
   LEN
----------------------------------------------------
```

Enqueue to full:
```
HEADER   MSG_0    MSG_1    MSG_2    MSG_3    MSG_4
----------------------------------------------------
[. 0 5]  {. aaa}  {. bbb}  {. ccc}  {. ddd}  {. eee}    # Queue is full
----------------------------------------------------
[X 0 5]  {. aaa}  {. bbb}  {. ccc}  {. ddd}  {. eee}    # Lock header
----------------------------------------------------
[X 1 5]  {X aaa}  {. bbb}  {. ccc}  {. ddd}  {. eee}    # Increment START_IDX, lock MSG_0
----------------------------------------------------
[. 1 5]  {X aaa}  {. bbb}  {. ccc}  {. ddd}  {. eee}    # Unlock header
----------------------------------------------------
[. 1 5]  {X fff}  {. bbb}  {. ccc}  {. ddd}  {. eee}    # Rewrite MSG_0 data
----------------------------------------------------
[. 1 5]  {. fff}  {. bbb}  {. ccc}  {. ddd}  {. eee}    # Unlock MSG_0
----------------------------------------------------
```

Enqueue to full with max shift:
```
HEADER   MSG_0    MSG_1    MSG_2    MSG_3    MSG_4
----------------------------------------------------
[. 4 5]  {. fff}  {. ggg}  {. hhh}  {. iii}  {. eee}    # Queue is full and shift is max:
----------------------------------------------------
[X 4 5]  {. fff}  {. ggg}  {. hhh}  {. iii}  {. eee}    # Lock header
----------------------------------------------------
[X 0 5]  {. fff}  {. ggg}  {. hhh}  {. iii}  {X eee}    # Cycle START_IDX, lock MSG_4
----------------------------------------------------
[. 0 5]  {. fff}  {. ggg}  {. hhh}  {. iii}  {X eee}    # Unlock header
----------------------------------------------------
[. 0 5]  {. fff}  {. ggg}  {. hhh}  {. iii}  {X jjj}    # Rewrite MSG_4 data
----------------------------------------------------
[. 0 5]  {. fff}  {. ggg}  {. hhh}  {. iii}  {. jjj}    # Unlock MSG_4
----------------------------------------------------
```

Dequeue from empty:
```
HEADER   MSG_0    MSG_1    MSG_2    MSG_3    MSG_4
----------------------------------------------------
[. 4 0]  {. ...}  {. ...}  {. ...}  {. ...}  {. ...}    # Queue is empty
----------------------------------------------------
[. 4 0]  {. ...}  {. ...}  {. ...}  {. ...}  {. ...}    # Wait while QUEUE_LEN != 0
----------------------------------------------------
[X 4 2]  {. ...}  {. ...}  {. ...}  {. ...}  {. ...}    # Lock header
----------------------------------------------------
                        ....                            # Same as below
----------------------------------------------------
```

Dequeue from half full:
```
HEADER   MSG_0    MSG_1    MSG_2    MSG_3    MSG_4
----------------------------------------------------
[. 0 3]  {. aaa}  {. bbb}  {. ccc}  {. ...}  {. ...}    # Queue is half full
----------------------------------------------------
[X 0 3]  {. aaa}  {. bbb}  {. ccc}  {. ...}  {. ...}    # Lock header
----------------------------------------------------
[X 1 2]  {X aaa}  {. bbb}  {. ccc}  {. ...}  {. ...}    # Decrement QUEUE_LEN, increment START_IDX, lock MSG_0
----------------------------------------------------
[. 1 2]  {X aaa}  {. bbb}  {. ccc}  {. ...}  {. ...}    # Unlock header
----------------------------------------------------
[. 1 2]  {X aaa}  {. bbb}  {. ccc}  {. ...}  {. ...}    # Read MSG_0 data
----------------------------------------------------
[. 1 2]  {. aaa}  {. bbb}  {. ccc}  {. ...}  {. ...}    # Unlock MSG_0
----------------------------------------------------
```

Dequeue from shifted:
```
HEADER   MSG_0    MSG_1    MSG_2    MSG_3    MSG_4
----------------------------------------------------
[. 3 3]  {. fff}  {. ...}  {. ...}  {. ddd}  {. eee}    # Queue is shifted
----------------------------------------------------
[X 3 3]  {. fff}  {. ...}  {. ...}  {. ddd}  {. eee}    # Lock header
----------------------------------------------------
[X 4 2]  {. fff}  {. ...}  {. ...}  {X ddd}  {. eee}    # Decrement QUEUE_LEN, increment START_IDX, lock MSG_3
----------------------------------------------------
[. 4 2]  {. fff}  {. ...}  {. ...}  {X ddd}  {. eee}    # Unlock header
----------------------------------------------------
[. 4 2]  {. fff}  {. ...}  {. ...}  {X ddd}  {. eee}    # Read MSG_3 data
----------------------------------------------------
[. 4 2]  {. fff}  {. ...}  {. ...}  {. ddd}  {. eee}    # Unlock MSG_3
----------------------------------------------------
```